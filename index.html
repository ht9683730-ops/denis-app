<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–≠–∫—Å–∫—É—Ä—Å–∏—è</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <script src="map-data.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { width: 100vw; height: 100vh; }
        .mode-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,.2);
            width: 300px;
        }
        .mode-panel button {
            display: block;
            width: 100%;
            margin-bottom: 6px;
            padding: 12px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #2196F3;
            color: white;
            transition: all 0.2s;
        }
        .mode-panel button:hover {
            background: #1976D2;
        }
        .admin-btn {
            background: #FF9800 !important;
        }
        .admin-btn:hover {
            background: #F57C00 !important;
        }
        .sync-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
<div class="sync-indicator" id="syncIndicator">
    ‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –∞–¥–º–∏–Ω–∫–æ–π
</div>

<div class="mode-panel">
    <button onclick="setMode('map')">üó∫ –ö–∞—Ä—Ç–∞</button>
    <button onclick="setMode('tour')">üö∂ –≠–∫—Å–∫—É—Ä—Å–∏—è</button>
    <button class="admin-btn" onclick="goToAdmin()">‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞</button>
</div>

<div id="map"></div>

<script>
/* ---------- –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ---------- */
let activeLocations = [];

function loadStoredData() {
    const stored = localStorage.getItem('tourData');
    if (stored) {
        const data = JSON.parse(stored);
        activeLocations = data.locations;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        const indicator = document.getElementById('syncIndicator');
        indicator.style.display = 'block';
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 3000);
        
        console.log('üì• –ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞–¥–º–∏–Ω–∫–∏:', activeLocations.length, '–ª–æ–∫–∞—Ü–∏–π');
    } else {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞
        activeLocations = locations;
        console.log('üìÑ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏–∑ map-data.js');
    }
}

loadStoredData();

/* ---------- –ù–ê–°–¢–†–û–ô–ö–ò ---------- */
const startPoint = [44.941992, 34.131292];
const bounds = [
    [44.934524, 34.125260],
    [44.946381, 34.136753]
];

/* ---------- –ö–ê–†–¢–ê ---------- */
const map = L.map('map', {
    center: startPoint,
    zoom: 16,
    minZoom: 16,
    maxZoom: 19,
    maxBounds: bounds,
    maxBoundsViscosity: 1
});

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

/* ---------- –°–¢–ò–õ–ò –¢–û–ß–ï–ö ---------- */
const normalStyle = {
    radius: 16,
    color: "black",
    weight: 2,
    fillColor: "orange",
    fillOpacity: 0.8
};

const startStyle = {
    radius: 16,
    color: "#0a7",
    weight: 3,
    fillColor: "#2ecc71",
    fillOpacity: 1
};

const endStyle = {
    radius: 16,
    color: "#c00",
    weight: 3,
    fillColor: "#e74c3c",
    fillOpacity: 1
};

/* ---------- –õ–û–ì–ò–ö–ê ---------- */
let mode = "map";
let tourStart = null;
let tourEnd = null;

function setMode(m) {
    resetTour();
    mode = m;
    if (mode === "map") {
        showAllPoints();
    }
    if (mode === "tour") {
        showTourStartPoints();
    }
}

/* ---------- –¢–û–ß–ö–ò ---------- */
activeLocations.forEach(loc => {
    const point = L.circleMarker([loc.lat, loc.lng], normalStyle)
        .bindTooltip(loc.name);
    
    point.on("click", () => {
        // –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –∫–∞—Ä—Ç—ã
        if (mode === "map") {
            window.location.href = `pano.html?id=${loc.id}`;
            return;
        }
        
        // —Ä–µ–∂–∏–º —ç–∫—Å–∫—É—Ä—Å–∏–∏
        if (!tourStart) {
            tourStart = loc;
            point.setStyle(startStyle);
            return;
        }
        
        if (!tourEnd && loc.id !== tourStart.id) {
            tourEnd = loc;
            point.setStyle(endStyle);
            startTour();
            return;
        }
        
        resetTour();
    });
    
    loc._point = point;
});

/* ---------- –§–£–ù–ö–¶–ò–ò ---------- */
function resetTour() {
    tourStart = null;
    tourEnd = null;
    activeLocations.forEach(l => {
        if (l._point) {
            l._point.setStyle(normalStyle);
        }
    });
}

function startTour() {
    window.location.href = 
        `pano.html?mode=tour&start=${tourStart.id}&end=${tourEnd.id}&step=0`;
}

function showAllPoints() {
    activeLocations.forEach(l => {
        if (l._point && !map.hasLayer(l._point)) {
            l._point.addTo(map);
        }
    });
}

function hideAllPoints() {
    activeLocations.forEach(l => {
        if (l._point && map.hasLayer(l._point)) {
            map.removeLayer(l._point);
        }
    });
}

function showTourStartPoints() {
    hideAllPoints();
    activeLocations.forEach(l => {
        if (l.tour === true && l._point) {
            l._point.addTo(map);
        }
    });
}

function goToAdmin() {
    window.location.href = 'admin.html';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏
showAllPoints();
</script>
</body>
</html>