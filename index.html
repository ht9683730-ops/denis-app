<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–≠–∫—Å–∫—É—Ä—Å–∏—è</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <script src="map-data.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { width: 100vw; height: 100vh; }
        
        /* –î–ï–°–ö–¢–û–ü–ù–ê–Ø –ü–ê–ù–ï–õ–¨ */
        .mode-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,.2);
            width: 300px;
        }
        
        .mode-panel button {
            display: block;
            width: 100%;
            margin-bottom: 6px;
            padding: 12px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #2196F3;
            color: white;
            transition: all 0.2s;
        }
        
        .mode-panel button:hover {
            background: #1976D2;
        }
        
        .admin-btn {
            background: #FF9800 !important;
        }
        
        .admin-btn:hover {
            background: #F57C00 !important;
        }
        
        /* –ë–£–†–ì–ï–† –ö–ù–û–ü–ö–ê - –¢–û–õ–¨–ö–û –ù–ê –ú–û–ë–ò–õ–ö–ê–• */
        .burger-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            background: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,.2);
            cursor: pointer;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            padding: 0;
            transition: all 0.3s;
        }
        
        .burger-btn:hover {
            background: #f5f5f5;
        }
        
        .burger-btn span {
            display: block;
            width: 25px;
            height: 3px;
            background: #333;
            border-radius: 2px;
            transition: all 0.3s;
        }
        
        .burger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }
        
        .burger-btn.active span:nth-child(2) {
            opacity: 0;
        }
        
        .burger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }
        
        /* –í–´–î–í–ò–ì–ê–Æ–©–ï–ï–°–Ø –ú–ï–ù–Æ */
        .side-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 10px rgba(0,0,0,.2);
            z-index: 999;
            padding: 70px 20px 20px 20px;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .side-menu.open {
            right: 0;
        }
        
        .side-menu h2 {
            margin: 0 0 20px 0;
            font-size: 20px;
            color: #333;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 998;
            display: none;
            transition: opacity 0.3s;
        }
        
        .menu-overlay.show {
            display: block;
        }
        
        .menu-btn {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 16px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background: #2196F3;
            color: white;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .menu-btn:hover {
            background: #1976D2;
            transform: translateX(-5px);
        }
        
        .menu-btn.admin {
            background: #FF9800;
        }
        
        .menu-btn.admin:hover {
            background: #F57C00;
        }
        
        .sync-indicator {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,.2);
        }

        /* –ê–î–ê–ü–¢–ò–í –î–õ–Ø –ú–û–ë–ò–õ–û–ö */
        @media (max-width: 768px) {
            /* –ü—Ä—è—á–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é –ø–∞–Ω–µ–ª—å */
            .mode-panel {
                display: none;
            }
            
            /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—É—Ä–≥–µ—Ä */
            .burger-btn {
                display: flex;
                width: 55px;
                height: 55px;
            }
            
            .burger-btn span {
                width: 28px;
                height: 3px;
            }
            
            .side-menu {
                width: 280px;
                right: -300px;
                padding: 80px 15px 20px 15px;
            }
            
            .menu-btn {
                padding: 18px;
                font-size: 17px;
                margin-bottom: 12px;
            }
            
            .sync-indicator {
                bottom: 20px;
                padding: 12px 24px;
                font-size: 15px;
            }
        }

        /* –î–õ–Ø –ú–ê–õ–ï–ù–¨–ö–ò–• –¢–ï–õ–ï–§–û–ù–û–í */
        @media (max-width: 480px) {
            .burger-btn {
                width: 50px;
                height: 50px;
            }
            
            .side-menu {
                width: 250px;
                right: -270px;
            }
            
            .menu-btn {
                padding: 16px;
                font-size: 16px;
            }
        }

        /* –î–õ–Ø –õ–ê–ù–î–®–ê–§–¢–ù–û–ô –û–†–ò–ï–ù–¢–ê–¶–ò–ò –ù–ê –ú–û–ë–ò–õ–ö–ê–• */
        @media (max-width: 768px) and (orientation: landscape) {
            .burger-btn {
                width: 45px;
                height: 45px;
                top: 5px;
                right: 5px;
            }
            
            .side-menu {
                width: 220px;
                right: -240px;
                padding: 60px 10px 10px 10px;
            }
            
            .side-menu h2 {
                font-size: 18px;
                margin-bottom: 15px;
            }
            
            .menu-btn {
                padding: 12px;
                font-size: 14px;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
<!-- –î–ï–°–ö–¢–û–ü–ù–ê–Ø –ü–ê–ù–ï–õ–¨ -->
<div class="mode-panel">
    <button onclick="setMode('map')">üó∫ –ö–∞—Ä—Ç–∞</button>
    <button onclick="setMode('tour')">üö∂ –≠–∫—Å–∫—É—Ä—Å–∏—è</button>
    <button class="admin-btn" onclick="goToAdmin()">‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞</button>
</div>

<!-- –ë–£–†–ì–ï–† –ö–ù–û–ü–ö–ê (–¢–û–õ–¨–ö–û –ú–û–ë–ò–õ–ö–ò) -->
<button class="burger-btn" id="burgerBtn" onclick="toggleMenu()">
    <span></span>
    <span></span>
    <span></span>
</button>

<!-- –ó–ê–¢–ï–ú–ù–ï–ù–ò–ï -->
<div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

<!-- –ë–û–ö–û–í–û–ï –ú–ï–ù–Æ -->
<div class="side-menu" id="sideMenu">
    <h2>üéì –ú–µ–Ω—é</h2>
    <button class="menu-btn" onclick="setModeAndClose('map')">üó∫ –ö–∞—Ä—Ç–∞</button>
    <button class="menu-btn" onclick="setModeAndClose('tour')">üö∂ –≠–∫—Å–∫—É—Ä—Å–∏—è</button>
    <button class="menu-btn admin" onclick="goToAdmin()">‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞</button>
</div>

<div class="sync-indicator" id="syncIndicator">
    ‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –∞–¥–º–∏–Ω–∫–æ–π
</div>

<div id="map"></div>

<script>
/* ---------- –ú–ï–ù–Æ ---------- */
function toggleMenu() {
    const menu = document.getElementById('sideMenu');
    const overlay = document.getElementById('menuOverlay');
    const burger = document.getElementById('burgerBtn');
    
    menu.classList.toggle('open');
    overlay.classList.toggle('show');
    burger.classList.toggle('active');
}

function closeMenu() {
    const menu = document.getElementById('sideMenu');
    const overlay = document.getElementById('menuOverlay');
    const burger = document.getElementById('burgerBtn');
    
    menu.classList.remove('open');
    overlay.classList.remove('show');
    burger.classList.remove('active');
}

function setModeAndClose(m) {
    setMode(m);
    closeMenu();
}

function goToAdmin() {
    window.location.href = 'admin.html';
}

/* ---------- –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ---------- */
let activeLocations = [];

function loadStoredData() {
    const stored = localStorage.getItem('tourData');
    if (stored) {
        const data = JSON.parse(stored);
        activeLocations = data.locations;
        
        const indicator = document.getElementById('syncIndicator');
        indicator.style.display = 'block';
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 3000);
        
        console.log('üì• –ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞–¥–º–∏–Ω–∫–∏:', activeLocations.length, '–ª–æ–∫–∞—Ü–∏–π');
    } else {
        activeLocations = locations;
        console.log('üìÑ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏–∑ map-data.js');
    }
}

loadStoredData();

/* ---------- –ù–ê–°–¢–†–û–ô–ö–ò ---------- */
const startPoint = [44.941992, 34.131292];
const bounds = [
    [44.934524, 34.125260],
    [44.946381, 34.136753]
];

/* ---------- –ö–ê–†–¢–ê ---------- */
const map = L.map('map', {
    center: startPoint,
    zoom: 16,
    minZoom: 16,
    maxZoom: 19,
    maxBounds: bounds,
    maxBoundsViscosity: 1
});

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

/* ---------- –°–¢–ò–õ–ò –¢–û–ß–ï–ö ---------- */
const isMobile = window.innerWidth <= 768;
const normalStyle = {
    radius: isMobile ? 14 : 16,
    color: "black",
    weight: isMobile ? 2 : 2,
    fillColor: "orange",
    fillOpacity: 0.8
};

const startStyle = {
    radius: isMobile ? 14 : 16,
    color: "#0a7",
    weight: isMobile ? 3 : 3,
    fillColor: "#2ecc71",
    fillOpacity: 1
};

const endStyle = {
    radius: isMobile ? 14 : 16,
    color: "#c00",
    weight: isMobile ? 3 : 3,
    fillColor: "#e74c3c",
    fillOpacity: 1
};

/* ---------- –õ–û–ì–ò–ö–ê ---------- */
let mode = "map";
let tourStart = null;
let tourEnd = null;

function setMode(m) {
    resetTour();
    mode = m;
    if (mode === "map") {
        showAllPoints();
    }
    if (mode === "tour") {
        showTourStartPoints();
    }
}

/* ---------- –¢–û–ß–ö–ò ---------- */
activeLocations.forEach(loc => {
    const point = L.circleMarker([loc.lat, loc.lng], normalStyle)
        .bindTooltip(loc.name, {
            permanent: false,
            direction: 'top',
            className: isMobile ? 'mobile-tooltip' : ''
        });
    
    point.on("click", () => {
        if (mode === "map") {
            window.location.href = `pano.html?id=${loc.id}`;
            return;
        }
        
        if (!tourStart) {
            tourStart = loc;
            point.setStyle(startStyle);
            return;
        }
        
        if (!tourEnd && loc.id !== tourStart.id) {
            tourEnd = loc;
            point.setStyle(endStyle);
            startTour();
            return;
        }
        
        resetTour();
    });
    
    loc._point = point;
});

/* ---------- –§–£–ù–ö–¶–ò–ò ---------- */
function resetTour() {
    tourStart = null;
    tourEnd = null;
    activeLocations.forEach(l => {
        if (l._point) {
            l._point.setStyle(normalStyle);
        }
    });
}

function startTour() {
    window.location.href = 
        `pano.html?mode=tour&start=${tourStart.id}&end=${tourEnd.id}&step=0`;
}

function showAllPoints() {
    activeLocations.forEach(l => {
        if (l._point && !map.hasLayer(l._point)) {
            l._point.addTo(map);
        }
    });
}

function hideAllPoints() {
    activeLocations.forEach(l => {
        if (l._point && map.hasLayer(l._point)) {
            map.removeLayer(l._point);
        }
    });
}

function showTourStartPoints() {
    hideAllPoints();
    activeLocations.forEach(l => {
        if (l.tour === true && l._point) {
            l._point.addTo(map);
        }
    });
}

showAllPoints();

// –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç—É
map.on('click', closeMenu);
</script>
</body>
</html>