<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω–∫–∞ - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Å–∫—É—Ä—Å–∏–µ–π</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0 0 10px 0;
        }
        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        .btn-primary:hover {
            background: #1976D2;
        }
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        .btn-success:hover {
            background: #45a049;
        }
        .btn-danger {
            background: #f44336;
            color: white;
        }
        .btn-danger:hover {
            background: #da190b;
        }
        .btn-secondary {
            background: #9E9E9E;
            color: white;
        }
        .btn-secondary:hover {
            background: #757575;
        }
        .content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        .locations-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .location-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        .location-item:hover {
            background: #e3f2fd;
        }
        .location-item.active {
            background: #e3f2fd;
            border-left-color: #2196F3;
        }
        .location-item.tour {
            border-right: 4px solid #4CAF50;
        }
        .editor {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: monospace;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        .hotspots-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }
        .hotspot-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #FF9800;
        }
        .hotspot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .hotspot-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .hotspot-type.info {
            background: #2196F3;
            color: white;
        }
        .hotspot-type.scene {
            background: #4CAF50;
            color: white;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state h2 {
            color: #666;
        }
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .image-preview {
            max-width: 300px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 4px;
            border: 2px solid #ddd;
        }
        .file-upload-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #FF9800;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .file-upload-btn:hover {
            background: #F57C00;
        }
        .file-upload-btn input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="save-indicator" id="saveIndicator">‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
    
    <div class="container">
        <div class="header">
            <h1>üéì –ê–¥–º–∏–Ω–∫–∞ —ç–∫—Å–∫—É—Ä—Å–∏–∏</h1>
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="loadFromFiles()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–æ–≤</button>
                <button class="btn btn-success" onclick="exportToFiles()">üì§ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ñ–∞–π–ª—ã</button>
                <button class="btn btn-secondary" onclick="addNewLocation()">‚ûï –ù–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è</button>
                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                <button class="btn btn-secondary" onclick="goToMap()">üó∫Ô∏è –ù–∞ –∫–∞—Ä—Ç—É</button>
            </div>
        </div>

        <div class="content">
            <div class="locations-list" id="locationsList">
                <!-- –°–ø–∏—Å–æ–∫ –ª–æ–∫–∞—Ü–∏–π -->
            </div>

            <div class="editor" id="editor">
                <div class="empty-state">
                    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é</h2>
                    <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª–æ–∫–∞—Ü–∏—é —Å–ª–µ–≤–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                </div>
            </div>
        </div>
    </div>

    <script src="map-data.js"></script>
    <script src="pano-data.js"></script>
    <script>
        let currentData = {
            locations: [],
            hotspots: {}
        };
        let currentLocationId = null;
        let db = null;

        // IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TourDatabase', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('images')) {
                        db.createObjectStore('images');
                    }
                };
            });
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ IndexedDB
        function saveImage(key, base64) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['images'], 'readwrite');
                const store = transaction.objectStore('images');
                const request = store.put(base64, key);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ IndexedDB
        function loadImage(key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['images'], 'readonly');
                const store = transaction.objectStore('images');
                const request = store.get(key);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            await initDB();
            loadData();
            renderLocationsList();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function loadData() {
            const saved = localStorage.getItem('tourData');
            if (saved) {
                currentData = JSON.parse(saved);
            } else {
                currentData.locations = JSON.parse(JSON.stringify(locations));
                currentData.hotspots = JSON.parse(JSON.stringify(panoHotSpots));
                saveData();
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function saveData() {
            localStorage.setItem('tourData', JSON.stringify(currentData));
            showSaveIndicator();
        }

        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –ª–æ–∫–∞—Ü–∏–π
        function renderLocationsList() {
            const list = document.getElementById('locationsList');
            list.innerHTML = currentData.locations
                .sort((a, b) => a.id - b.id)
                .map(loc => `
                    <div class="location-item ${loc.tour ? 'tour' : ''} ${currentLocationId === loc.id ? 'active' : ''}"
                         onclick="selectLocation(${loc.id})">
                        <strong>ID ${loc.id}</strong> - ${loc.name}
                        ${loc.tour ? '<span style="color:#4CAF50; float:right;">‚òÖ</span>' : ''}
                    </div>
                `).join('');
        }

        // –í—ã–±–æ—Ä –ª–æ–∫–∞—Ü–∏–∏
        function selectLocation(id) {
            currentLocationId = id;
            renderLocationsList();
            renderEditor();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
            indicator.style.display = 'block';

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const base64 = e.target.result;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ IndexedDB
                    const imageKey = `pano_${currentLocationId}_${Date.now()}`;
                    await saveImage(imageKey, base64);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø–∞–Ω–æ—Ä–∞–º–µ
                    const loc = currentData.locations.find(l => l.id === currentLocationId);
                    if (loc) {
                        loc.panorama = imageKey;
                    }
                    
                    saveData();
                    renderEditor();
                    
                    indicator.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                        indicator.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                    }, 2000);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
                    indicator.style.display = 'none';
                    indicator.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                }
            };
            
            reader.onerror = () => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞!');
                indicator.style.display = 'none';
                indicator.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            };
            
            reader.readAsDataURL(file);
        }

        // –†–µ–Ω–¥–µ—Ä —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        async function renderEditor() {
            const loc = currentData.locations.find(l => l.id === currentLocationId);
            if (!loc) return;

            const hotspots = currentData.hotspots[currentLocationId] || [];
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º preview –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            let imagePreview = '';
            if (loc.panorama.startsWith('pano_')) {
                try {
                    const base64 = await loadImage(loc.panorama);
                    if (base64) {
                        imagePreview = `<img src="${base64}" class="image-preview" alt="Preview">`;
                    }
                } catch (e) {
                    console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ IndexedDB');
                }
            } else if (loc.panorama.startsWith('images/')) {
                imagePreview = `<img src="${loc.panorama}" class="image-preview" alt="Preview">`;
            }

            document.getElementById('editor').innerHTML = `
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${loc.name}</h2>
                
                <div class="form-group">
                    <label>ID –ª–æ–∫–∞—Ü–∏–∏</label>
                    <input type="number" value="${loc.id}" disabled>
                </div>

                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="locName" value="${loc.name}" 
                           onchange="updateLocation('name', this.value)">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>–®–∏—Ä–æ—Ç–∞ (lat)</label>
                        <input type="number" step="0.000001" id="locLat" value="${loc.lat}"
                               onchange="updateLocation('lat', parseFloat(this.value))">
                    </div>
                    <div class="form-group">
                        <label>–î–æ–ª–≥–æ—Ç–∞ (lng)</label>
                        <input type="number" step="0.000001" id="locLng" value="${loc.lng}"
                               onchange="updateLocation('lng', parseFloat(this.value))">
                    </div>
                </div>

                <div class="form-group">
                    <label>–ü–∞–Ω–æ—Ä–∞–º–Ω–æ–µ —Ñ–æ—Ç–æ</label>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <label class="file-upload-btn">
                            üìé –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ
                            <input type="file" accept="image/*" onchange="handleImageUpload(event)">
                        </label>
                        <span style="color: #666; font-size: 14px;">
                            ${loc.panorama.startsWith('pano_') ? '‚úì –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (IndexedDB)' : loc.panorama}
                        </span>
                    </div>
                    ${imagePreview}
                </div>

                <div class="form-row-3">
                    <div class="form-group">
                        <label>Start Yaw (–ø–æ–≤–æ—Ä–æ—Ç)</label>
                        <input type="number" id="locYaw" value="${loc.startYaw}"
                               onchange="updateLocation('startYaw', parseInt(this.value))">
                    </div>
                    <div class="form-group">
                        <label>Start Pitch (–Ω–∞–∫–ª–æ–Ω)</label>
                        <input type="number" id="locPitch" value="${loc.startPitch}"
                               onchange="updateLocation('startPitch', parseInt(this.value))">
                    </div>
                    <div class="form-group">
                        <label>Start FOV</label>
                        <input type="number" id="locFov" value="${loc.startFov || 75}"
                               onchange="updateLocation('startFov', parseInt(this.value))">
                    </div>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="locTour" ${loc.tour ? 'checked' : ''}
                           onchange="updateLocation('tour', this.checked)">
                    <label for="locTour" style="margin:0;">–î–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —ç–∫—Å–∫—É—Ä—Å–∏–π (tour)</label>
                </div>

                <div class="hotspots-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0;">Hotspots (—Ç–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞)</h3>
                        <button class="btn btn-primary" onclick="addHotspot()">‚ûï –î–æ–±–∞–≤–∏—Ç—å hotspot</button>
                    </div>

                    <div id="hotspotsList">
                        ${hotspots.length === 0 ? '<p style="color:#999;">–ù–µ—Ç hotspots</p>' : 
                          hotspots.map((h, idx) => renderHotspotItem(h, idx)).join('')}
                    </div>
                </div>
            `;
        }

        // –†–µ–Ω–¥–µ—Ä –æ–¥–Ω–æ–≥–æ hotspot
        function renderHotspotItem(h, idx) {
            return `
                <div class="hotspot-item">
                    <div class="hotspot-header">
                        <span class="hotspot-type ${h.type}">${h.type === 'info' ? 'üìç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è' : '‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥'}</span>
                        <button class="btn btn-danger" style="padding:4px 12px; font-size:12px;"
                                onclick="deleteHotspot(${idx})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Pitch (–≤–µ—Ä—Ç–∏–∫–∞–ª—å)</label>
                            <input type="number" value="${h.pitch}"
                                   onchange="updateHotspot(${idx}, 'pitch', parseInt(this.value))">
                        </div>
                        <div class="form-group">
                            <label>Yaw (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å)</label>
                            <input type="number" value="${h.yaw}"
                                   onchange="updateHotspot(${idx}, 'yaw', parseInt(this.value))">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>–¢–∏–ø</label>
                        <select onchange="updateHotspot(${idx}, 'type', this.value)">
                            <option value="info" ${h.type === 'info' ? 'selected' : ''}>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</option>
                            <option value="scene" ${h.type === 'scene' ? 'selected' : ''}>–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ü–µ–Ω—É</option>
                        </select>
                    </div>

                    ${h.type === 'scene' ? `
                        <div class="form-group">
                            <label>ID —Ü–µ–ª–µ–≤–æ–π –ª–æ–∫–∞—Ü–∏–∏</label>
                            <input type="text" value="${h.targetId || ''}"
                                   onchange="updateHotspot(${idx}, 'targetId', this.value)">
                        </div>
                    ` : ''}

                    <div class="form-group">
                        <label>–¢–µ–∫—Å—Ç (–¥–ª—è scene - –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏, –¥–ª—è info - HTML)</label>
                        <textarea onchange="updateHotspot(${idx}, 'text', this.value)">${h.text || ''}</textarea>
                    </div>
                </div>
            `;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏
        function updateLocation(field, value) {
            const loc = currentData.locations.find(l => l.id === currentLocationId);
            if (loc) {
                loc[field] = value;
                saveData();
                renderLocationsList();
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ hotspot
        function addHotspot() {
            if (!currentData.hotspots[currentLocationId]) {
                currentData.hotspots[currentLocationId] = [];
            }
            currentData.hotspots[currentLocationId].push({
                pitch: 0,
                yaw: 0,
                type: 'info',
                text: '–ù–æ–≤—ã–π hotspot'
            });
            saveData();
            renderEditor();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ hotspot
        function updateHotspot(idx, field, value) {
            currentData.hotspots[currentLocationId][idx][field] = value;
            saveData();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ hotspot
        function deleteHotspot(idx) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç hotspot?')) {
                currentData.hotspots[currentLocationId].splice(idx, 1);
                saveData();
                renderEditor();
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –ª–æ–∫–∞—Ü–∏–∏
        function addNewLocation() {
            const maxId = Math.max(...currentData.locations.map(l => l.id), 0);
            const newLoc = {
                id: maxId + 1,
                name: `–õ–æ–∫–∞—Ü–∏—è ${maxId + 1}`,
                lat: 44.941992,
                lng: 34.131292,
                panorama: "images/default.jpg",
                startYaw: 0,
                startPitch: 0,
                tour: false
            };
            currentData.locations.push(newLoc);
            currentData.hotspots[newLoc.id] = [];
            saveData();
            renderLocationsList();
            selectLocation(newLoc.id);
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–∞–π–ª—ã
        function exportToFiles() {
            const mapDataContent = `const locations = ${JSON.stringify(currentData.locations, null, 4)};\n\nconst entrance = {\n    lat: 44.9428,\n    lng: 34.1278,\n    text: "–í–•–û–î"\n};`;
            
            const panoDataContent = `const panoHotSpots = ${JSON.stringify(currentData.hotspots, null, 4)};`;

            downloadFile('map-data.js', mapDataContent);
            downloadFile('pano-data.js', panoDataContent);

            alert('–§–∞–π–ª—ã —Å–∫–∞—á–∞–Ω—ã!\n\n–í–ù–ò–ú–ê–ù–ò–ï: –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ üìé —Ñ–æ—Ç–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ IndexedDB.\n–î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–∞–π—Ç–∞ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ –≤ –ø–∞–ø–∫—É images/');
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ñ–∞–π–ª–æ–≤
        function loadFromFiles() {
            if (confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ map-data.js –∏ pano-data.js?\n–¢–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ localStorage –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã.')) {
                currentData.locations = JSON.parse(JSON.stringify(locations));
                currentData.hotspots = JSON.parse(JSON.stringify(panoHotSpots));
                saveData();
                renderLocationsList();
                alert('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Ñ–∞–π–ª–æ–≤!');
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function clearAllData() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ (localStorage + IndexedDB)?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                localStorage.removeItem('tourData');
                
                // –û—á–∏—Å—Ç–∫–∞ IndexedDB
                const transaction = db.transaction(['images'], 'readwrite');
                const store = transaction.objectStore('images');
                await store.clear();
                
                location.reload();
            }
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É
        function goToMap() {
            window.location.href = 'index.html';
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>